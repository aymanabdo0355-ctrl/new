--[[ 
    Xes Hub - ABA Script
    UI: Rayfield
]] 

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local isAltAccount = false
local isMainAccount = false
local desyncEnabled = false
local desyncActive = false
local Connections = {}
local webhookUrl = ""
local autoNanamiEnabled = false
local perfectBlackFlashEnabled = false

LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

task.spawn(function()
    while task.wait(1) do
        pcall(function()
            local rematchEvent = ReplicatedStorage:FindFirstChild("RematchVote")
            if rematchEvent then
                rematchEvent:FireServer()
            end
        end)
    end
end)

local function SendWebhook(title, description, color)
    if webhookUrl == "" or webhookUrl == "YOUR_WEBHOOK_URL_HERE" then return end
    
    local data = {
        ["embeds"] = {{
            ["title"] = title,
            ["description"] = description,
            ["color"] = color,
            ["footer"] = {
                ["text"] = "xes | " .. os.date("%X")
            }
        }}
    }
    
    pcall(function()
        local jsonData = HttpService:JSONEncode(data)
        request({
            Url = webhookUrl,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = jsonData
        })
    end)
end

local function EnableDesync()
    if desyncActive then return end
    local success = pcall(function() setfflag("NextGenReplicatorEnabledWrite4", "True") end)
    if success then
        task.wait(0.1)
        local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then humanoid:ChangeState(Enum.HumanoidStateType.Dead) end
        
        if Connections['DesyncRespawn'] then Connections['DesyncRespawn']:Disconnect() end
        Connections['DesyncRespawn'] = LocalPlayer.CharacterAdded:Connect(function(newCharacter)
            if not desyncEnabled then
                if Connections['DesyncRespawn'] then
                    Connections['DesyncRespawn']:Disconnect()
                    Connections['DesyncRespawn'] = nil
                end
                return
            end
            task.wait(0.5)
            pcall(function() setfflag("NextGenReplicatorEnabledWrite4", "False") end)
            task.wait(0.1)
            pcall(function() setfflag("NextGenReplicatorEnabledWrite4", "True") end)
            desyncActive = true
        end)
    else
        desyncEnabled = false
        return false
    end
    return true
end

local function DisableDesync()
    desyncEnabled, desyncActive = false, false
    if Connections['DesyncRespawn'] then
        Connections['DesyncRespawn']:Disconnect()
        Connections['DesyncRespawn'] = nil
    end
    pcall(function() setfflag("NextGenReplicatorEnabledWrite4", "False") end)
end

local function ResetCharacter()
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildWhichIsA("Humanoid")
    if humanoid then
        humanoid:ChangeState(Enum.HumanoidStateType.Dead)
    end
end

print("[xes] loaded")

local Window = Rayfield:CreateWindow({
    Name = "xes",
    LoadingTitle = "xes",
    LoadingSubtitle = "init",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = nil,
        FileName = "xes"
    },
    Discord = {
        Enabled = false,
        Invite = "",
        RememberJoins = false
    },
    KeySystem = false
})

local MainTab = Window:CreateTab("farm", 4483362458)

local FarmSection = MainTab:CreateSection("modes")

local AltToggle = MainTab:CreateToggle({
    Name = "alt mode",
    CurrentValue = false,
    Flag = "Alt",
    Callback = function(Value)
        isAltAccount = Value
        
        if Value then
            if not Connections['AltReset'] then
                Connections['AltReset'] = task.spawn(function()
                    while isAltAccount do
                        task.wait(1)
                        pcall(ResetCharacter)
                    end
                end)
            end
        else
            if Connections['AltReset'] then
                pcall(function() task.cancel(Connections['AltReset']) end)
                Connections['AltReset'] = nil
            end
        end
    end,
})

local MainToggle = MainTab:CreateToggle({
    Name = "main mode",
    CurrentValue = false,
    Flag = "Main",
    Callback = function(Value)
        isMainAccount = Value
    end,
})

local DesyncSection = MainTab:CreateSection("network")

local DesyncToggle = MainTab:CreateToggle({
    Name = "desync",
    CurrentValue = false,
    Flag = "Desync",
    Callback = function(Value)
        desyncEnabled = Value
        if Value then
            EnableDesync()
        else
            DisableDesync()
        end
    end,
})

local SettingsTab = Window:CreateTab("config", 4483362458)

local RenderSection = SettingsTab:CreateSection("performance")

local Render3DToggle = SettingsTab:CreateToggle({
    Name = "disable 3d render",
    CurrentValue = false,
    Flag = "Render3D",
    Callback = function(Value)
        if Value then
            RunService:Set3dRenderingEnabled(false)
            print("[xes] 3d rendering off")
        else
            RunService:Set3dRenderingEnabled(true)
            print("[xes] 3d rendering on")
        end
    end,
})

local WebhookSection = SettingsTab:CreateSection("webhook")

local WebhookInput = SettingsTab:CreateInput({
    Name = "url",
    PlaceholderText = "discord webhook",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        webhookUrl = Text
        
        if Text ~= "" and Text ~= "YOUR_WEBHOOK_URL_HERE" then
            SendWebhook(
                "xes connected",
                "user: " .. LocalPlayer.Name,
                5763719
            )
        end
    end,
})

local WebhookTest = SettingsTab:CreateButton({
    Name = "test",
    Callback = function()
        if webhookUrl == "" or webhookUrl == "YOUR_WEBHOOK_URL_HERE" then
            print("[xes] no webhook set")
        else
            SendWebhook("test", "webhook works", 3066993)
        end
    end,
})

local InfoSection = SettingsTab:CreateSection("status")
local InfoLabel = SettingsTab:CreateLabel("afk bypass: active")
local InfoLabel2 = SettingsTab:CreateLabel("auto rematch: active")

local CombatTab = Window:CreateTab("combat", 4483362458)

local WarningSection = CombatTab:CreateSection("warning")
local WarningLabel = CombatTab:CreateLabel("blatant features")

local CombatSection = CombatTab:CreateSection("auto")

local AutoNanamiToggle = CombatTab:CreateToggle({
    Name = "nanami timing",
    CurrentValue = false,
    Flag = "Nanami",
    Callback = function(Value)
        autoNanamiEnabled = Value
        
        if Value then
            if not Connections['NanamiHandler'] then
                local NanamiEvent = ReplicatedStorage:FindFirstChild("NanamiCheck")
                if NanamiEvent then
                    Connections['OriginalNanami'] = NanamiEvent.OnClientInvoke
                    
                    NanamiEvent.OnClientInvoke = function(Target, TimeDur, User)
                        if not autoNanamiEnabled then
                            if Connections['OriginalNanami'] then
                                return Connections['OriginalNanami'](Target, TimeDur, User)
                            end
                            return false
                        end
                        
                        local CutGUI = ReplicatedStorage:FindFirstChild("NanamiCutGUI")
                        if not CutGUI then return false end
                        
                        local Live = workspace:WaitForChild('Live')
                        local TempGUI = CutGUI:Clone()
                        TempGUI.MainBar.Rotation = -80
                        TempGUI.Parent = Live[Target.Name].HumanoidRootPart
                        TempGUI.Adornee = Live[Target.Name].HumanoidRootPart
                        local MainBar = TempGUI.MainBar
                        local Cutter = MainBar.Cutter
                        local Temp1, Temp2, Temp3 = false, false, false
                        
                        local InputConnection = UserInputService.InputBegan:Connect(function(InputObject)
                            if not Temp1 then
                                if InputObject.UserInputType == Enum.UserInputType.MouseButton1 or InputObject.KeyCode == Enum.KeyCode.ButtonB then
                                    if Temp2 then
                                        Temp3 = true
                                        return
                                    end
                                    Temp1 = true
                                end
                            end
                        end)
                        
                        local Counter = .005
                        local Time = 0
                        while Counter < 1 and (User:GetAttribute('NANAMIAIM') and not (Temp3 or Temp1)) do
                            local Timed = task.wait()
                            local Division = Timed / TimeDur
                            local Difference = math.abs(.7 - Counter)
                            if Counter < .7 then
                                MainBar.Rotation = Counter/.7*80-80
                            else
                                MainBar.Rotation = 0
                            end
                            if Difference < .025 then
                                Division = Division / 8
                            elseif Difference < .05 then
                                Division = Division / 4
                            end
                            Counter = Counter + Division
                            Cutter.Position = UDim2.fromScale(Counter, .5)
                            if Difference < .02 then
                                Temp2 = true
                                Temp3 = true
                            else
                                Temp2 = false
                            end
                            if Temp2 then
                                Time = Time + Timed
                            end
                        end
                        InputConnection:Disconnect()
                        
                        if Temp3 and User:GetAttribute('NANAMIAIM') then
                            Cutter.Position = UDim2.fromScale(.7, .5)
                            TweenService:Create(TempGUI, TweenInfo.new(.25), {['Size'] = UDim2.new(10,200,10,200)}):Play()
                            Cutter.Size = UDim2.fromScale(.016, 12)
                            TweenService:Create(Cutter, TweenInfo.new(0.5, Enum.EasingStyle.Linear), {
                                ['Size'] = UDim2.fromScale(0, 24);
                                ['BackgroundColor3'] = Color3.new(1,0,0);
                                ['BackgroundTransparency'] = 1
                            }):Play()
                            local ColorCorrection = Instance.new("ColorCorrectionEffect", game.Lighting)
                            ColorCorrection.TintColor = Color3.new(0,0,0)
                            game:GetService("Debris"):AddItem(ColorCorrection, .15)
                        end
                        game:GetService("Debris"):AddItem(TempGUI, .5)
                        return Temp3
                    end
                end
            end
        end
    end,
})

local PerfectBlackFlashToggle = CombatTab:CreateToggle({
    Name = "black flash",
    CurrentValue = false,
    Flag = "BlackFlash",
    Callback = function(Value)
        perfectBlackFlashEnabled = Value
        
        if Value then
            if not Connections['BlackFlashHandler'] then
                Connections['BlackFlashHandler'] = task.spawn(function()
                    while perfectBlackFlashEnabled do
                        task.wait()
                        pcall(function()
                            local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
                            local BlackFlashGui = PlayerGui:FindFirstChild("BlackFlash")
                            
                            if BlackFlashGui and BlackFlashGui.Enabled then
                                local Frame = BlackFlashGui:FindFirstChild("Frame")
                                if Frame then
                                    local Cutter = Frame:FindFirstChild("Cutter")
                                    local Bar = Frame:FindFirstChild("Bar")
                                    
                                    if Cutter and Bar then
                                        local cutterPos = Cutter.Position.X.Scale
                                        local barPos = Bar.Position.X.Scale
                                        local difference = math.abs(cutterPos - barPos)
                                        
                                        if difference < 0.02 then
                                            VirtualUser:CaptureController()
                                            VirtualUser:ClickButton1(Vector2.new())
                                        end
                                    end
                                end
                            end
                        end)
                    end
                end)
            end
        else
            if Connections['BlackFlashHandler'] then
                pcall(function() task.cancel(Connections['BlackFlashHandler']) end)
                Connections['BlackFlashHandler'] = nil
            end
        end
    end,
})

local autoSkipBansEnabled = true

task.spawn(function()
    task.wait(2)
    local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
    
    Connections['AutoSkipBans'] = PlayerGui.ChildAdded:Connect(function(Child)
        task.wait()
        
        if not autoSkipBansEnabled then return end
        
        pcall(function()
            if Child.Name == 'BanChooser' then
                local RemoteEvent = Child:FindFirstChild('Communicate', true)
                if RemoteEvent then
                    RemoteEvent:FireServer('pass')
                end
            elseif Child.Name == 'MapBan' then
                task.wait(.5)
                for _, v in pairs(Child.Frame.Maps:GetChildren()) do
                    if v:FindFirstChild('Title') then
                        local MapBanner = ReplicatedStorage:FindFirstChild("MapBanner")
                        if MapBanner then
                            MapBanner:FireServer(v.Title.Text)
                        end
                        break
                    end
                end
            end
        end)
    end)
end)

local AutoSkipBansToggle = CombatTab:CreateToggle({
    Name = "skip bans",
    CurrentValue = true,
    Flag = "SkipBans",
    Callback = function(Value)
        autoSkipBansEnabled = Value
    end,
})

Rayfield:LoadConfiguration()
